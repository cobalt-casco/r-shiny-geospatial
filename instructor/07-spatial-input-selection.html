<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Shiny Webapps with R for Geospatial Exploration: Spatial Selection</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="manifest" href="../site.webmanifest"><link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><abbr class="badge badge-light" title="This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team." style="background-color: #001483; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#polishing-beta-stage" class="external-link alert-link" style="color: #FFF7F1">
            <i aria-hidden="true" class="icon" data-feather="alert-circle" style="border-radius: 5px"></i>
            Beta
          </a>
          <span class="visually-hidden">This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../07-spatial-input-selection.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Shiny Webapps with R for Geospatial Exploration
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Shiny Webapps with R for Geospatial Exploration
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled><input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset></form>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Shiny Webapps with R for Geospatial Exploration
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 89%" class="percentage">
    89%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 89%" aria-valuenow="89" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../07-spatial-input-selection.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-intro-to-shiny.html">1. Introduction to Shiny</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-shiny-ui.html">2. The Basics of a User Interface</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-input-output.html">3. Inputs and Outputs</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-reactives.html">4. Reactive Objects in Shiny</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-publishing-shiny-app.html">5. Making Shiny Apps Public</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-translating-shiny.html">6. Translating a Shiny App</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        7. Spatial Selection
        </span>
      </button>
    </div><!--/div.accordion-header-->
        
    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#our-app-so-far">Our App So Far</a></li>
<li><a href="#leaflet-in-shiny-apps">Leaflet in Shiny Apps</a></li>
<li><a href="#making-a-reactive-leaflet-map">Making a Reactive Leaflet Map</a></li>
<li><a href="#using-elements-of-a-leaflet-map-as-input">Using Elements of a Leaflet Map as Input</a></li>
<li><a href="#selecting-with-your-map-in-leaflet">Selecting With Your Map in Leaflet</a></li>
<li><a href="#selecting-with-a-draw-box">Selecting with a Draw Box</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="../instructor/aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/06-translating-shiny.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/06-translating-shiny.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Translating a Shiny
        </a>
        <a class="chapter-link float-end" href="../instructor/index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Spatial Selection</h1>
        <p>Last updated on 2024-01-12 |
        
        <a href="https://github.com/cobalt-casco/r-shiny-geospatial/edit/main/episodes/07-spatial-input-selection.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 35 minutes</p>
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How can I use interactive maps as an input select?</li>
<li>How can I make my spatial apps more interactive?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Use leaflet in Shiny.</li>
<li>Demonstrate the basic building blocks of a Shiny app.</li>
</ul></div>
</div>
</div>
</div>
</div>
<section id="our-app-so-far"><h2 class="section-heading">Our App So Far<a class="anchor" aria-label="anchor" href="#our-app-so-far"></a>
</h2>
<hr class="half-width"><p>We’ve been doing great work on our app to look at seagrass beds in
Casco Bay. Let’s summarize where we are so far, although we will remove
the histogram for the moment.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Preamble</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">shiny</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">shinythemes</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_casco</span> <span class="op">&lt;-</span> <span class="fu">readRDS</span><span class="op">(</span><span class="st">"data/joined_seagrass_cover.Rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Define a User Interface</span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>  title <span class="op">=</span> <span class="st">"Seagrass in Casco App"</span>,</span>
<span>  theme <span class="op">=</span> <span class="fu">shinytheme</span><span class="op">(</span><span class="st">"sandstone"</span><span class="op">)</span>,</span>
<span>  </span>
<span> <span class="fu">titlePanel</span><span class="op">(</span><span class="st">"Seagrass in Casco Bay over time"</span><span class="op">)</span>,</span>
<span> </span>
<span> <span class="fu">sidebarLayout</span><span class="op">(</span></span>
<span>   </span>
<span>   <span class="co"># sidebar</span></span>
<span>   <span class="fu">sidebarPanel</span><span class="op">(</span></span>
<span>     <span class="fu">selectInput</span><span class="op">(</span></span>
<span>       inputId <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>       label <span class="op">=</span> <span class="st">"Choose a year:"</span>,</span>
<span>       choices <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sort</span><span class="op">(</span><span class="op">)</span>,</span>
<span>       selected <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">min</span><span class="op">(</span><span class="op">)</span> <span class="co">#to get the earliest year</span></span>
<span>       <span class="op">)</span>,</span>
<span>     </span>
<span>     <span class="fu">checkboxGroupInput</span><span class="op">(</span></span>
<span>       inputId <span class="op">=</span> <span class="st">"cover"</span>,</span>
<span>       label <span class="op">=</span> <span class="st">"Percent Cover Classes:"</span>,</span>
<span>       choices <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">cover_pct</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sort</span><span class="op">(</span><span class="op">)</span>,</span>
<span>       selected <span class="op">=</span>  <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">cover_pct</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sort</span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">)</span>, </span>
<span>   <span class="op">)</span>,</span>
<span>   </span>
<span>   <span class="co"># main</span></span>
<span>   <span class="fu">mainPanel</span><span class="op">(</span></span>
<span>     <span class="fu">plotOutput</span><span class="op">(</span><span class="st">"map"</span><span class="op">)</span>,</span>
<span>   <span class="op">)</span></span>
<span> <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. define a server</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># our map block</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">cover_pct</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">1.5</span>, </span>
<span>              color <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>This is great, BUT, it could be improved greatly in two ways. First,
why not have our map me more interactive - a leaflet map! Second, let’s
actually add some color to our beds by cover.</p>
</section><section id="leaflet-in-shiny-apps"><h2 class="section-heading">Leaflet in Shiny Apps<a class="anchor" aria-label="anchor" href="#leaflet-in-shiny-apps"></a>
</h2>
<hr class="half-width"><p>Forunately, <code>leaflet</code> provides functions to work inside of
a Shiny app just like a plot. There is a <code>leafletOutput()</code>
and <code>renderLeaflet()</code> function. We can simply change the
<code>plotOutput("map")</code> in our UI to
<code>leafletOutput("map")</code>. Then, we can modify the server.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 3. define a server</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># our map block</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">cover_pct</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, </span>
<span>                  color <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>                  weight <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<figure><img src="../fig/shiny_figs/leaf_shiny.jpeg" alt="" class="figure mx-auto d-block"><figcaption>Shiny app with leaflet map</figcaption></figure></section><section id="making-a-reactive-leaflet-map"><h2 class="section-heading">Making a Reactive Leaflet Map<a class="anchor" aria-label="anchor" href="#making-a-reactive-leaflet-map"></a>
</h2>
<hr class="half-width"><p>While this is awesome, as we can change our map easily, one
frustration you might have noticed is that every time you change an
input, the map resets its field of view. That’s because every time you
change an input, Shiny re-runs the output, and it remakes the map from
scratch. Not ideal.</p>
<p>Instead, we can use <code>leafletProxy()</code> to update a map. To
use <code>leafletProxy()</code>, we first create a map output with only
the parts of the map that will not respond to inputs. We can then treat
our map as a reactive object insofar as we will use
<code>observe()</code> to make changes are made. In our case, as our
selectors change the data used for the map, we will make the data a
reactive, and then use the reactive data for the <code>observe()</code>
statement.</p>
<p>Within our <code>observe()</code>, we will use
<code>leafletProxy()</code> with the argument <code>mapId</code> to
refer to the leaflet output - in this case <code>"map"</code>. To it, we
will also have to add <code>clearShapes()</code> in order to plot only
what we are selecting. Otherwise, layers will be added on layers will be
added on layers will be….</p>
<p>Let’s look at our new server with the reactive, a static map (that
includes bounds, as otherwise we’d start at a global scale), and our
observe statement.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## A reactive for data</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">seagrass_casco</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">cover_pct</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## An initial map with **only** elements that one' change</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co">#we will need some initial bounds</span></span>
<span>    <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">as.numeric</span><span class="op">(</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">fitBounds</span><span class="op">(</span><span class="va">b</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## An observe statement to update the map</span></span>
<span>  <span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># here we use leafletProxy()</span></span>
<span>    <span class="fu">leafletProxy</span><span class="op">(</span>mapId <span class="op">=</span> <span class="st">"map"</span>, data <span class="op">=</span> <span class="fu">dat</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">clearShapes</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span> </span>
<span>                  color <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>                  weight <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>This now works as advertised!</p>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
<div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>Instructor Note</h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" aria-labelledby="headingInstructor1" data-bs-parent="#accordionInstructor1">
<div class="accordion-body">
<p>Let’s add a challenge to put in a color scale for cover, but the
color scale can change - say, give the user the options of Greens and
viridis as the palette</p>
</div>
</div>
</div>
</div>
</section><section id="using-elements-of-a-leaflet-map-as-input"><h2 class="section-heading">Using Elements of a Leaflet Map as Input<a class="anchor" aria-label="anchor" href="#using-elements-of-a-leaflet-map-as-input"></a>
</h2>
<hr class="half-width"><p>As we have constructed a beautiful visualization of seagrass beds in
Casco Bay, maybe we want to know more about each of those individual
beds. We know that each polygon has a lot of information associated with
it. For example.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span></code></pre>
</div>
<p>Let’s say, for each bed, we want to be able to click on it and see
the information in that row of data. With leaflet maps, we can actually
do this without Shiny to some degree with the <code>popup</code>
argument. So, for example, we can make a map of 1997 with popups. We
will use <code>paste()</code> to make the text understandable.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">1997</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>popup <span class="op">=</span> <span class="op">~</span><span class="fu">paste</span><span class="op">(</span><span class="st">"Acres: "</span>, <span class="va">acres</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>We can do this for more than just acres. We can also use the
<code>label</code> argument to make this information popup when we just
mouse over the polygon.</p>
<p>This might be all you need! But, what if we want to <em>do
something</em> with the selected polygon data. Let’s say, for example,
we wanted to output the row of data the polygon came from. To do that,
we need to give each polygon an individual ID. Let’s add
<code>bed_id</code> column to the data that is just the row number. We
can put this in our preamble.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seagrass_casco</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>bed_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>To add this to our app, we can now add a <code>layerId</code>
argument to our polygon. We will use <code>~</code> to say that we are
going to evaluate one of the variables from</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## An observe statement to update the map</span></span>
<span>  <span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># here we use leafletProxy()</span></span>
<span>    <span class="fu">leafletProxy</span><span class="op">(</span>mapId <span class="op">=</span> <span class="st">"map"</span>, data <span class="op">=</span> <span class="fu">dat</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">clearShapes</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span> </span>
<span>                  color <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>                  weight <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>                  layerId <span class="op">=</span> <span class="op">~</span><span class="va">bed_id</span><span class="op">)</span></span>
<span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>So, now that we have layer IDs, how can we make them respond to
clicking on polygons? The answer is that interacting with
<code>leaflet</code> maps does trigger an input. We interact with maps
in two ways. One is with the whole map. The other is with just pieces.
Let’s focus on the later. The input triggered is</p>
<pre><code><span><span class="va">input</span><span class="op">$</span><span class="va">MAPID_OBJCATEGORY_EVENTNAME</span></span></code></pre>
<p>where MAPID is the input ID of the map (here <code>map</code>),
OBJCATEGORY is a category descriptor of an object in a leaflet map. See
<a href="https://rstudio.github.io/leaflet/shiny.html" class="external-link">here</a> for a
list of valid ones - what concerns us is <code>shape</code> and
<code>marker</code>. And last, EVENTNAME which is either
<code>click</code>, <code>mouseover</code> or <code>mouseout</code>.</p>
<p>So, for a click on a polygon, we’d be looking at</p>
<pre><code><span><span class="va">input</span><span class="op">$</span><span class="va">map_shape_click</span></span></code></pre>
<p>To show what this outputs, let’s insert two pieces into our code.
First, in the UI, add <code>verbatimTextOutput("layer_click")</code> and
to the server add</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">output</span><span class="op">$</span><span class="va">layer_click</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">capture.output</span><span class="op">(</span><span class="fu">print</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">map_shape_click</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>From this, when we run the ap and click on a bed, we get output like
this</p>
<pre><code>$id [1] 3824  $.nonce [1] 0.8434182  $lat [1] 43.79836  $lng [1] -70.10101 </code></pre>
<p>OH! A list! With an ID which is the <code>bed_id</code>. We can do
something with that!</p>
<p>For the moment, let’s just show the hectares of the bed clicked on.
We can do that by filtering to the bed ID and outputting text.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">output</span><span class="op">$</span><span class="va">layer_click</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">one_row</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco</span> <span class="op">|&gt;</span> <span class="fu">filter</span><span class="op">(</span><span class="va">bed_id</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">map_shape_click</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">paste</span><span class="op">(</span><span class="st">"This bed is"</span>, <span class="va">one_row</span><span class="op">$</span><span class="va">hectares</span>, <span class="st">"hectares"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Ew. What’s that initial output? To fix output when there is no click,
we need to return something for the <code>NULL</code> case.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">output</span><span class="op">$</span><span class="va">layer_click</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu">is.null</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">map_shape_click</span><span class="op">)</span><span class="op">)</span> <span class="kw">return</span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">one_row</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco</span> <span class="op">|&gt;</span> <span class="fu">filter</span><span class="op">(</span><span class="va">bed_id</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">map_shape_click</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">paste</span><span class="op">(</span><span class="st">"This bed is"</span>, <span class="va">one_row</span><span class="op">$</span><span class="va">hectares</span>, <span class="st">"hectares"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span>  </span></code></pre>
</div>
</section><section id="selecting-with-your-map-in-leaflet"><h2 class="section-heading">Selecting With Your Map in Leaflet<a class="anchor" aria-label="anchor" href="#selecting-with-your-map-in-leaflet"></a>
</h2>
<hr class="half-width"><p>What if, instead of what we’ve clicked on, we want information about
the area we are looking within? We have two options. The first is to use
the map itself as our selector. Like the
<code>input$MAPID_OBJCATEGORY_EVENTNAME</code> above, there is also just
an <code>input$MAPID_EVENTNAME</code> for the whole map.</p>
<p>These events include <code>click</code> which will return the
<code>lat</code> and <code>lng</code> of where you click,
<code>center</code> which does the same for where your map is centered,
<code>zoom</code> which will return your zoom level, and
<code>bounds</code> which will return the corner coordinates of your
map. <code>north</code>, <code>east</code>, <code>south</code>, and
<code>west</code>.</p>
<p>Below our text output in the UI, let’s add a
<code>plotOutput("hectare_hist")</code> and in our UI add a function
that crops our reactive <code>dat()</code> to the bounds of our
<code>input$bounds</code>. We can <code>st_crop()</code> with an
<code>st_bbox()</code> made from the bounds.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># show the bed hectares</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hectare_hist</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># our crop box</span></span>
<span>    <span class="co">#xmin ymin xmax ymax </span></span>
<span>    <span class="va">crop_box</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="fu">c</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">west</span>,</span>
<span>                        ymin <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">south</span>,</span>
<span>                        xmax <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">east</span>,</span>
<span>                        ymax <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">north</span><span class="op">)</span>,</span>
<span>                        crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">hist_data</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="fu">dat</span><span class="op">(</span><span class="op">)</span>, <span class="va">crop_box</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hist_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">hectares</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
</section><section id="selecting-with-a-draw-box"><h2 class="section-heading">Selecting with a Draw Box<a class="anchor" aria-label="anchor" href="#selecting-with-a-draw-box"></a>
</h2>
<hr class="half-width"><p>If you want to get fancy and use a drawing box instead, we need to
use something extra - the <a href="https://bhaskarvk.github.io/leaflet.extras/index.html" class="external-link">leaflet.extras</a>
package. Lots of people have written Javascript extensions to Leaflet.
This package and <a href="https://trafficonese.github.io/leaflet.extras2/" class="external-link">leaflet.extras2</a>
have tried to capture some of these into R. For our purposes, we need to
add an <code>addDrawToolbar()</code> to our map in the server.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## An initial map with **only** elements that one' change</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co">#we will need some initial bounds</span></span>
<span>    <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">as.numeric</span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">fitBounds</span><span class="op">(</span><span class="va">b</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addDrawToolbar</span><span class="op">(</span>position <span class="op">=</span> <span class="st">"topright"</span>,</span>
<span>                     editOptions <span class="op">=</span> </span>
<span>                       <span class="fu">editToolbarOptions</span><span class="op">(</span>edit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Note the <code>editOptions</code>. That’s just so we can have a trash
can to get rid of selectors once we are done.</p>
<p>This toolbar now produces the ability to draw shapes on a map and
return information from them. Again, as above, using one of these will
generate an input.</p>
<pre><code><span><span class="va">input</span><span class="op">$</span><span class="va">MAPID_draw_EVENTNAME</span></span></code></pre>
<p>There are a wide variety of EVENTNAME possibilities which are listed
<a href="https://github.com/bhaskarvk/leaflet.extras/blob/f133b64c6148414e64cd12cf54814746e7261d99/inst/examples/shiny/draw-events/app.R#L28" class="external-link">here</a>.
For our purposes, as we want to make a new histogram every time a square
is drawn, we want <code>input$map_draw_new_feature</code> which triggers
anytime a new feature is drawn.</p>
<p>What does this input return? Unfortunately, what it returns is a list
in the <code>geojson</code> format. Fortunately, we can use the <a href="https://cran.r-project.org/web/packages/geojsonsf/index.html" class="external-link">geojsonsf</a>
package to turn it into an sf object, and then crop as before to make
the histogram. Let’s change our histogram in our server to</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># show the bed hectares</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hectare_hist</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># good behavior</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu">is.null</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">map_draw_new_feature</span><span class="op">)</span><span class="op">)</span> <span class="kw">return</span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># our crop box</span></span>
<span>    <span class="va">selected_shape</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">map_draw_new_feature</span></span>
<span>    </span>
<span>    <span class="va">crop_sf</span> <span class="op">&lt;-</span> </span>
<span>      <span class="fu">geojsonsf</span><span class="fu">::</span><span class="fu">geojson_sf</span><span class="op">(</span><span class="fu">jsonify</span><span class="fu">::</span><span class="fu">to_json</span><span class="op">(</span><span class="va">selected_shape</span>, unbox <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">hist_data</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="fu">dat</span><span class="op">(</span><span class="op">)</span>, <span class="va">crop_sf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hist_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">hectares</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>And now take it for a spin!</p>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>That was a lot! For your future reference, here is the final code for
the app by the end of this lesson. It’s a mid-sized app, but, a really
nice one that accomplishes some very fancy tasks! Well done!</p>
<p>If you want to see a working version of it, <a href="https://shiny.umb.edu/shiny/users/jarrett.byrnes/casco_seagrass/" class="external-link">try
this link</a>.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Preamble</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">shiny</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">shinythemes</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">leaflet.extras</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_casco</span> <span class="op">&lt;-</span> <span class="fu">readRDS</span><span class="op">(</span><span class="st">"data/joined_seagrass_cover.Rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seagrass_casco</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>bed_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># 2. Define a User Interface</span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>  title <span class="op">=</span> <span class="st">"Seagrass in Casco App"</span>,</span>
<span>  theme <span class="op">=</span> <span class="fu">shinytheme</span><span class="op">(</span><span class="st">"sandstone"</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu">titlePanel</span><span class="op">(</span><span class="st">"Seagrass in Casco Bay over time"</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu">sidebarLayout</span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># sidebar</span></span>
<span>    <span class="fu">sidebarPanel</span><span class="op">(</span></span>
<span>      <span class="fu">selectInput</span><span class="op">(</span></span>
<span>        inputId <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        label <span class="op">=</span> <span class="st">"Choose a year:"</span>,</span>
<span>        choices <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sort</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        selected <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">min</span><span class="op">(</span><span class="op">)</span> <span class="co">#to get the earliest year</span></span>
<span>      <span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="fu">checkboxGroupInput</span><span class="op">(</span></span>
<span>        inputId <span class="op">=</span> <span class="st">"cover"</span>,</span>
<span>        label <span class="op">=</span> <span class="st">"Percent Cover Classes:"</span>,</span>
<span>        choices <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">cover_pct</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sort</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        selected <span class="op">=</span>  <span class="fu">unique</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">$</span><span class="va">cover_pct</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sort</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span>, </span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># main</span></span>
<span>    <span class="fu">mainPanel</span><span class="op">(</span></span>
<span>      <span class="fu">leafletOutput</span><span class="op">(</span><span class="st">"map"</span><span class="op">)</span>,</span>
<span>      <span class="fu">verbatimTextOutput</span><span class="op">(</span><span class="st">"layer_click"</span><span class="op">)</span>,</span>
<span>      <span class="fu">plotOutput</span><span class="op">(</span><span class="st">"hectare_hist"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. define a server</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## A reactive for data</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">reactive</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">seagrass_casco</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">cover_pct</span> <span class="op">%in%</span> <span class="va">input</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## An initial map with **only** elements that one' change</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co">#we will need some initial bounds</span></span>
<span>    <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">seagrass_casco</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">as.numeric</span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addProviderTiles</span><span class="op">(</span><span class="st">"Esri.WorldTopoMap"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">fitBounds</span><span class="op">(</span><span class="va">b</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">b</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addDrawToolbar</span><span class="op">(</span>position <span class="op">=</span> <span class="st">"topright"</span>,</span>
<span>                     editOptions <span class="op">=</span> </span>
<span>                       <span class="fu">editToolbarOptions</span><span class="op">(</span>edit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## An observe statement to update the map</span></span>
<span>  <span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># here we use leafletProxy()</span></span>
<span>    <span class="fu">leafletProxy</span><span class="op">(</span>mapId <span class="op">=</span> <span class="st">"map"</span>, data <span class="op">=</span> <span class="fu">dat</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">clearShapes</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span> </span>
<span>        color <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>        weight <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>        layerId <span class="op">=</span> <span class="op">~</span><span class="va">bed_id</span><span class="op">)</span></span>
<span>    </span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">layer_click</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu">is.null</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">map_shape_click</span><span class="op">)</span><span class="op">)</span> <span class="kw">return</span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">one_row</span> <span class="op">&lt;-</span> <span class="va">seagrass_casco</span> <span class="op">|&gt;</span> <span class="fu">filter</span><span class="op">(</span><span class="va">bed_id</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">map_shape_click</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">paste</span><span class="op">(</span><span class="st">"This bed is"</span>, <span class="va">one_row</span><span class="op">$</span><span class="va">hectares</span>, <span class="st">"hectares"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># show the bed hectares</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hectare_hist</span> <span class="op">&lt;-</span> <span class="fu">renderPlot</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># good behavior</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu">is.null</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">map_draw_new_feature</span><span class="op">)</span><span class="op">)</span> <span class="kw">return</span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># our crop box</span></span>
<span>    <span class="va">selected_shape</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">map_draw_new_feature</span></span>
<span>    </span>
<span>    <span class="va">crop_sf</span> <span class="op">&lt;-</span> </span>
<span>      <span class="fu">geojsonsf</span><span class="fu">::</span><span class="fu">geojson_sf</span><span class="op">(</span><span class="fu">jsonify</span><span class="fu">::</span><span class="fu">to_json</span><span class="op">(</span><span class="va">selected_shape</span>, unbox <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">hist_data</span> <span class="op">&lt;-</span> <span class="fu">st_crop</span><span class="op">(</span><span class="fu">dat</span><span class="op">(</span><span class="op">)</span>, <span class="va">crop_sf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hist_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">hectares</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>We can use leaflet objects in Shiny.</li>
<li>Leaflets by their nature generate inputs when we perform
actions.</li>
<li>These inputs follow standard naming conventions.</li>
<li>We can use these inputs to filter or crop our data to produce more
outputs.</li>
</ul></div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/06-translating-shiny.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/06-translating-shiny.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Translating a Shiny
        </a>
        <a class="chapter-link float-end" href="../instructor/index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/cobalt-casco/r-shiny-geospatial/edit/main/episodes/07-spatial-input-selection.Rmd" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/cobalt-casco/r-shiny-geospatial/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/cobalt-casco/r-shiny-geospatial/" class="external-link">Source</a></p>
				<p><a href="https://github.com/cobalt-casco/r-shiny-geospatial/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:jarrett.byrnes@umb.edu">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.2" class="external-link">sandpaper (0.16.2)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.3" class="external-link">pegboard (0.7.3)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.1" class="external-link">varnish (1.0.1)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://cobalt-casco.github.io/r-shiny-geospatial/instructor/07-spatial-input-selection.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, R, shiny, geospatial",
  "name": "Spatial Selection",
  "creativeWorkStatus": "active",
  "url": "https://cobalt-casco.github.io/r-shiny-geospatial/instructor/07-spatial-input-selection.html",
  "identifier": "https://cobalt-casco.github.io/r-shiny-geospatial/instructor/07-spatial-input-selection.html",
  "dateCreated": "2024-01-07",
  "dateModified": "2024-01-12",
  "datePublished": "2024-01-12"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

